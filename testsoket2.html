<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ML Plot with ECharts</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    #charts-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      padding: 20px;
    }
    .chart-box {
      width: 45%;
      height: 400px;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h2>üéØ K·∫øt qu·∫£ ph√¢n lo·∫°i t·ª´ m√¥ h√¨nh ML</h2>
  <button id="connectBtn">K·∫øt n·ªëi v√† nh·∫≠n d·ªØ li·ªáu</button>
  <div id="charts-container"></div>

  <script>
    const socket = io("http://localhost:5000"); // ƒê·∫£m b·∫£o tr√πng c·ªïng server Flask
    const connectBtn = document.getElementById("connectBtn");
    const chartsContainer = document.getElementById("charts-container");

    connectBtn.onclick = () => {
      socket.emit("client_request_plot_data");
    };

    socket.on("plot_data", (results) => {
      console.log("üì© Nh·∫≠n d·ªØ li·ªáu t·ª´ server:", results);
      chartsContainer.innerHTML = "";  // Clear c≈©

      // B∆∞·ªõc 1: T·∫°o DOM tr∆∞·ªõc
      const chartDivs = [];
      Object.entries(results).forEach(([modelName, data]) => {
        const scatterId = `scatter-${modelName}`;
        const cumsumId = `cumsum-${modelName}`;

        chartsContainer.innerHTML += `
          <div class="chart-box" id="${scatterId}"></div>
          <div class="chart-box" id="${cumsumId}"></div>
        `;

        chartDivs.push({ modelName, scatterId, cumsumId, data });
      });

      // B∆∞·ªõc 2: Sau khi DOM ƒë∆∞·ª£c render xong, m·ªõi kh·ªüi t·∫°o ECharts
      setTimeout(() => {
        chartDivs.forEach(({ modelName, scatterId, cumsumId, data }) => {
          // Scatter Chart
          const scatterChart = echarts.init(document.getElementById(scatterId));
          scatterChart.setOption({
            title: { text: `${modelName} - Scatter (Acc: ${data.accuracy}%)` },
            xAxis: { name: 'Dim 1' },
            yAxis: { name: 'Dim 2' },
            tooltip: {
              formatter: (params) => {
                const d = params.data;
                return `Pred: ${d[2]}<br>True: ${d[3]}`;
              }
            },
            series: [{
              type: 'scatter',
              symbolSize: 8,
              data: data.scatter.map(p => [p.x, p.y, p.pred, p.true]),
              itemStyle: {
                color: (params) =>
                  params.data[2] === params.data[3] ? '#4caf50' : '#f44336'
              },
              encode: { tooltip: [2, 3] }
            }]
          });

          // Cumsum Chart
          const cumsumChart = echarts.init(document.getElementById(cumsumId));
          cumsumChart.setOption({
            title: { text: `${modelName} - C·ªông d·ªìn ƒë√∫ng/sai` },
            xAxis: { type: 'category', name: 'Sample' },
            yAxis: { type: 'value', name: 'T·ªïng ƒëi·ªÉm' },
            tooltip: { trigger: 'axis' },
            series: [{
              data: data.cumsum,
              type: 'line',
              smooth: true,
              lineStyle: { color: '#2196f3' },
              markLine: {
                data: [{ yAxis: 0 }],
                lineStyle: { type: 'dashed', color: '#aaa' }
              }
            }]
          });
        });
      }, 50); // Delay 50ms ƒë·ªÉ ƒë·∫£m b·∫£o DOM s·∫µn s√†ng
    });

    socket.on("connect", () => {
      console.log("‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi server.");
    });
  </script>
</body>
</html>
